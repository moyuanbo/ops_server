<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <!-- 本地资源引入 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 预留CSS扩展块 -->
    {% block css %}{% endblock %}
    <style>
        /* 初始隐藏过渡，避免页面加载时触发不必要的动画 */
        .sidebar {
          transition: none !important;
        }
        /* 状态稳定后启用过渡（通过JS添加类） */
        .sidebar.transition-enabled {
          transition: width 0.3s ease, padding 0.3s ease;
        }
        /* 固定主内容区过渡，配合侧边栏宽度变化 */
        .main-content {
          transition: margin-left 0.3s ease;
        }
  </style>
</head>
<body>
    <nav class="top-navbar">
        <div class="container-fluid p-0">
            <div class="d-flex w-100 justify-content-between">
                <!-- 左侧：仅登录状态显示系统名称 -->
                {% if current_user.is_authenticated %}
                    <div class="d-flex align-items-center">
                        <button id="mobile-sidebar-toggle" class="d-md-none btn text-light mr-2">
                            <i class="fa fa-bars"></i>
                        </button>
                        <a class="navbar-brand px-4" href="{{ url_for('admin.index') }}">运维系统</a>
                    </div>
                {% endif %}

                <!-- 右侧：登录入口 -->
                <div class="d-flex align-items-center px-4">
                    {% if not current_user.is_authenticated %}
                        <a class="nav-link text-light login-entry" href="{{ url_for('auth.login') }}">
                            <i class="fa fa-sign-in"></i> 登录入口
                        </a>
                    {% else %}
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-light" href="#" id="userDropdown" role="button"
                               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fa fa-user"></i> {{ current_user.real_name }}
                            </a>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                                <a class="dropdown-item" href="{{ url_for('admin.user_profile') }}">
                                    <i class="fa fa-user-circle"></i> 个人中心
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                                    <i class="fa fa-sign-out"></i> 退出登录
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <div class="app-container">
        <!-- 左侧：仅登录状态显示 -->
        {% if current_user.is_authenticated %}
            <!-- 左侧侧边栏：修复折叠状态类 -->
            <aside class="sidebar {% if sidebar_collapsed %}collapsed{% endif %}">
                <div class="sidebar-header">
                    <div class="sidebar-logo">
                        <i class="fa fa-cogs"></i>
                        <span class="sidebar-logo-text">运维系统</span>
                    </div>
                    <!-- 修复按钮ID与jQuery选择器匹配问题 -->
                    <button id="toggle-sidebar" class="btn btn-sm text-light">
                        <i class="fa {% if sidebar_collapsed %}fa-chevron-right{% else %}fa-chevron-left{% endif %}"></i>
                    </button>
                </div>

                <!-- 功能模块分组 -->
                <div class="sidebar-menu">
                    {% if current_user.is_admin %}
                        <div class="menu-group">
                            <div class="menu-group-title">核心管理</div>
                            <ul class="menu-items">
                                <li class="menu-item {{ 'active' if request.path == url_for('admin.dashboard') else '' }}">
                                    <a href="{{ url_for('admin.dashboard') }}">
                                        <i class="fa fa-tachometer-alt"></i>
                                        <span class="menu-text">控制台</span>
                                    </a>
                                </li>
                                <li class="menu-item {{ 'active' if 'user_list' in request.path else '' }}">
                                    <a href="{{ url_for('admin.user_list') }}">
                                        <i class="fa fa-users"></i>
                                        <span class="menu-text">用户管理</span>
                                    </a>
                                </li>
                                <li class="menu-item {{ 'active' if 'system_status' in request.path else '' }}">
                                    <a href="{{ url_for('admin.system_status') }}">
                                        <i class="fa fa-server"></i>
                                        <span class="menu-text">系统状态</span>
                                    </a>
                                </li>
                            </ul>
                        </div>

                        <!-- 资产管理 -->
                        <div class="menu-group">
                            <div class="menu-group-title">资产管理</div>
                            <ul class="menu-items">
                                <li class="menu-item {{ 'active' if 'entity_list' in request.path else '' }}">
                                    <a href="{{ url_for('channel_management.entity_list') }}">
                                        <i class="fa fa-server"></i>
                                        <span class="menu-text">渠道列表</span>
                                    </a>
                                </li>
                                <li class="menu-item {{ 'active' if 'entity_list' in request.path else '' }}">
                                    <a href="{{ url_for('game_management.entity_list') }}">
                                        <i class="fa fa-server"></i>
                                        <span class="menu-text">游戏服列表</span>
                                    </a>
                                </li>
                                <li class="menu-item {{ 'active' if 'entity_list' in request.path else '' }}">
                                    <a href="{{ url_for('server_management.entity_list') }}">
                                        <i class="fa fa-server"></i>
                                        <span class="menu-text">服务器列表</span>
                                    </a>
                                </li>
                                <li class="menu-item {{ 'active' if 'entity_list' in request.path else '' }}">
                                    <a href="{{ url_for('mysql_management.entity_list') }}">
                                        <i class="fa fa-server"></i>
                                        <span class="menu-text">MySQL列表</span>
                                    </a>
                                </li>
                            </ul>
                        </div>

                        <!-- 运维功能 -->
                        <div class="menu-group">
                            <div class="menu-group-title">游戏运维</div>
                            <ul class="menu-items">
                                <li class="menu-item {{ 'active' if 'add_index' in request.path else '' }}">
                                    <a href="{{ url_for('ops_game.add_index') }}">
                                        <i class="fa fa-list"></i>
                                        <span class="menu-text">添加游戏服</span>
                                    </a>
                                </li>
                                <li class="menu-item {{ 'active' if 'generator' in request.path else '' }}">
                                    <a href="{{ url_for('ops_game.generator_list') }}">
                                        <i class="fa fa-list"></i>
                                        <span class="menu-text">生成列表</span>
                                    </a>
                                </li>
                                <li class="menu-item {{ 'active' if 'update_game' in request.path else '' }}">
                                    <a href="{{ url_for('ops_game.update_game') }}">
                                        <i class="fa fa-gamepad"></i>
                                        <span class="menu-text">更新游戏</span>
                                    </a>
                                </li>
                                <li class="menu-item {{ 'active' if 'battle_game' in request.path else '' }}">
                                    <a href="{{ url_for('ops_game.battle_game') }}">
                                        <i class="fa fa-gamepad"></i>
                                        <span class="menu-text">更新录像</span>
                                    </a>
                                </li>
                                <li class="menu-item {{ 'active' if 'reload_game' in request.path else '' }}">
                                    <a href="{{ url_for('ops_game.reload_game') }}">
                                        <i class="fa fa-sync"></i>  <!-- 替换为同步图标 -->
                                        <span class="menu-text">热更游戏</span>
                                    </a>
                                </li>
                                <!-- 前端更新菜单 -->
                                <li class="menu-item {{ 'active' if 'update_client' in request.path else '' }}">
                                    <a href="{{ url_for('ops_game.update_client') }}">
                                        <i class="fa fa-code"></i>
                                        <span class="menu-text">前端更新</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    {% endif %}
                </div>
            </aside>
            <!-- 小屏侧边栏遮罩层 -->
            <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
        {% endif %}

        <!-- 主内容区 -->
        <main class="main-content" id="main-content">
            <div class="table-container">
                <!-- 消息提示 -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- 本地JS资源引入 -->
    <script src="{{ url_for('static', filename='js/jquery-3.5.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/popper.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- 侧边栏交互脚本（统一使用jQuery逻辑） -->
    {% block scripts %}
        <script>
            // 工具函数：读取Cookie（核心：获取XSRF-TOKEN）
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }
            $(document).ready(function() {
                $.ajaxSetup({
                    contentType: 'application/json',
                    // 携带CSRF Token到请求头
                    beforeSend: function(xhr) {
                        const xsrfToken = getCookie('XSRF-TOKEN');
                        if (xsrfToken) {
                            xhr.setRequestHeader('X-XSRF-TOKEN', xsrfToken);
                        }
                    },
                    // 统一处理Token过期
                    error: function(xhr) {
                        if (xhr.status === 401) {
                            const res = xhr.responseJSON;
                            if (res && res.msg.includes('Token')) {
                                alert(res.msg);
                                // 跳转到登录页
                                window.location.href = '/login.html';
                            }
                        }
                    }
                });

                // 动态计算导航栏高度并设置CSS变量
                const navbar = $('.top-navbar');
                const navbarHeight = navbar.outerHeight();
                document.documentElement.style.setProperty('--navbar-height', `${navbarHeight}px`);

                const sidebar = $('.sidebar');
                const toggleBtn = $('#toggle-sidebar');
                const storageKey = 'isSidebarCollapsed';
                const mobileToggleBtn = $('#mobile-sidebar-toggle');
                const backdrop = $('#sidebar-backdrop');

                // 小屏幕下默认折叠侧边栏（覆盖localStorage）
                const initSidebarState = () => {
                    const isSmallScreen = window.innerWidth <= 768;
                    let isCollapsed = localStorage.getItem(storageKey) === 'true';

                    // 小屏幕强制默认折叠
                    if (isSmallScreen) {
                        sidebar.removeClass('collapsed').addClass('show');
                        isCollapsed = false;
                        localStorage.setItem(storageKey, 'false');

                        // 小屏幕默认隐藏侧边栏
                        if (window.innerWidth <= 768) {
                            sidebar.removeClass('show');
                        }
                    }

                    return isCollapsed;
                };

                // 1. 页面加载后启用过渡效果
                sidebar.addClass('transition-enabled');

                // 2. 从localStorage恢复折叠状态并设置初始图标
                const isCollapsed = initSidebarState();
                if (isCollapsed) {
                    sidebar.addClass('collapsed');
                    toggleBtn.find('i').removeClass('fa-chevron-left').addClass('fa-chevron-right');
                }

                // 3. 点击折叠按钮，切换状态并保存
                toggleBtn.on('click', function() {
                    const newCollapsedState = !sidebar.hasClass('collapsed');
                    sidebar.toggleClass('collapsed', newCollapsedState);

                    // 更新按钮图标
                    const icon = toggleBtn.find('i');
                    if (newCollapsedState) {
                        icon.removeClass('fa-chevron-left').addClass('fa-chevron-right');
                    } else {
                        icon.removeClass('fa-chevron-right').addClass('fa-chevron-left');
                    }

                    // 保存状态到localStorage
                    localStorage.setItem(storageKey, String(newCollapsedState));
                });

                // 移动端：侧边栏切换
                mobileToggleBtn.on('click', function() {
                    sidebar.toggleClass('show');
                    backdrop.toggleClass('show');
                });

                // 点击遮罩层关闭侧边栏
                backdrop.on('click', function() {
                    sidebar.removeClass('show');
                    backdrop.removeClass('show');
                });
                // 窗口大小变化时调整布局
                $(window).resize(function() {
                    if (window.innerWidth > 768) {
                        sidebar.removeClass('expanded-on-mobile');
                    } else if (!sidebar.hasClass('show')) {
                        sidebar.addClass('show');
                    }
                });
            });
        </script>
    {% endblock %}
</body>
</html>
